<!DOCTYPE html>
<html>
<head>
    <style>
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }
      body {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f7f7f7;
        font-family: sans-serif;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
      }
      #myCanvas {
        border: 2px solid black;
        background: #fff;
        touch-action: none;
        margin-bottom: 20px;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
      }
      .controls button, .controls input[type="color"], .controls input[type="number"] {
        cursor: pointer;
        margin: 0 10px;
        padding: 4px 8px;
      }
    </style>
</head>
<body>
<div class="app">
    <div class="controls">
        <span>
            Brush Color: <input type="color" id="colorPicker" value="#000000">
        </span>
        <span>
            BG Color: <input type="color" id="bgColorPicker" value="#ffffff">
        </span>
        <span>
            Brush Size: <input type="range" id="brushSize" min="1" max="50" value="5"> <input type="number" id="brushSizeNum" min="1" max="50" value="5">
        </span>
    </div>
    <div class="controls">
        <button id="clear">Reset</button>
        <button id="saveAsPng">Save As PNG</button>
        <button id="saveProgress">Save Progress</button>
        <button id="undo">Undo</button>
        <button id="redo">Redo</button>
    </div>
    <canvas id="myCanvas" width="800" height="500"></canvas><br>
</div>

<script>
window.addEventListener('load', () => {
    const canvas = document.getElementById('myCanvas');
    const context = canvas.getContext('2d');
    const clearBtn = document.getElementById('clear');
    const colorPicker = document.getElementById('colorPicker');
    const saveAsPngBtn = document.getElementById('saveAsPng');
    const saveProgressBtn = document.getElementById('saveProgress');
    const undoBtn = document.getElementById('undo');
    const redoBtn = document.getElementById('redo');
    const bgColorPicker = document.getElementById('bgColorPicker');
    const brushSize = document.getElementById('brushSize');
    const brushSizeNum = document.getElementById('brushSizeNum');
    const history = [];
    let index = -1;
    let drawing = false;
    let bgColor = '#ffffff';

    // Resize the canvas to fit the screen
    const resizeCanvas = () => {
        canvas.width = window.innerWidth * 0.95;
        canvas.height = window.innerHeight * 0.8;
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    canvas.addEventListener('mousedown', (e) => {
        drawing = true;
        draw(e.clientX - canvas.offsetLeft, 
             e.clientY - canvas.offsetTop);
    });
    canvas.addEventListener('mousemove', (e) => {
        if (!drawing) return;
        draw(e.clientX - canvas.offsetLeft, 
             e.clientY - canvas.offsetTop);
    });
    canvas.addEventListener('mouseup', stop);
    canvas.addEventListener('mouseout', stop);

    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        drawing = true;
        const touch = e.touches[0];
        draw(touch.clientX - canvas.offsetLeft, 
             touch.clientY - canvas.offsetTop);
    });
    canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (!drawing) return;
        const touch = e.touches[0];
        draw(touch.clientX - canvas.offsetLeft, 
             touch.clientY - canvas.offsetTop);
    });
    canvas.addEventListener('touchend', stop);
    canvas.addEventListener('touchcancel', stop);

    bgColorPicker.addEventListener('change', () => {
        bgColor = bgColorPicker.value;
        context.fillStyle = bgColor;
        context.fillRect(0, 0, canvas.width, canvas.height);
    });

    clearBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to reset the drawing? This cannot be undone.')) {
            context.fillStyle = bgColor;
            context.fillRect(0, 0, canvas.width, canvas.height);
            history.length = 0;
            index = -1;
        }
    });

    saveProgressBtn.addEventListener('click', () => {
        const data = {
            img: canvas.toDataURL(),
            bgColor: bgColor,
        };
        localStorage.setItem('drawing', JSON.stringify(data));
        alert('Your progress has been saved.');
    });

    saveAsPngBtn.addEventListener('click', () => {
        const dataUrl = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = 'drawing.png';
        link.click();
    });

    // Load the data from local storage
    const savedData = JSON.parse(localStorage.getItem('drawing'));
    if (savedData) {
        const img = new Image();
        img.src = savedData.img;
        img.onload = () => {
            context.fillStyle = savedData.bgColor;
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.drawImage(img, 0, 0);
            history.push(savedData.img);
            index = 0;
        };
        bgColor = savedData.bgColor;
        bgColorPicker.value = savedData.bgColor;
    } else {
        context.fillStyle = bgColor;
        context.fillRect(0, 0, canvas.width, canvas.height);
    }
});
</script>
</body>
</html>
